# - name: "install node exporter."
#   unarchive:
#     src: https://github.com/prometheus/node_exporter/releases/download/v1.3.1/node_exporter-1.3.1.linux-amd64.tar.gz
#     dest: /tmp
#     remote_src: yes
#     validate_certs: false 
# - name: "move binary to /usr/local/bin."
#   become: true
#   copy:
#     src: /tmp/node_exporter-1.3.1.linux-amd64/node_exporter
#     dest: /usr/local/bin/node_exporter
#     remote_src: yes
#     mode: '0777'
    
# - name: "add node exporter configuration."
#   become: true  
#   copy:
#     src: node_exporter.service
#     dest: /etc/systemd/system/

# - name: "enable node_exporter service"
#   become: true
#   systemd:
#     state: restarted
#     daemon_reload: yes
#     name: node_exporter
#     enabled: yes


### ai code :
---
# Define variables at the top level for this role execution
# vars have been moved to a separate file

# ----- TASKS START HERE -----

# Task 1: Download the archive ON THE TARGET using curl
- name: "Download node exporter archive on target using curl"
  ansible.builtin.shell:
    cmd: "curl -L -s -S -o {{ node_exporter_archive_path }} {{ node_exporter_download_url }}"
    creates: "{{ node_exporter_archive_path }}"
  register: download_result
  failed_when: download_result.rc != 0 and 'already exists' not in download_result.stderr|default('') # Added default filter
- name: "Download node exporter archive on target using curl"
  ansible.builtin.shell:
    cmd: "curl -L -s -S -o {{ node_exporter_archive_path }} {{ node_exporter_download_url }}"
    creates: "{{ node_exporter_archive_path }}"
  register: download_result
  failed_when: 
    - download_result.rc != 0
    - "'already exists' not in download_result.stderr|default('')"
  become: false


# Task 3: Move the binary to the final location
- name: "Move node_exporter binary to {{ node_exporter_binary_path }}"
  ansible.builtin.copy:
    src: "{{ node_exporter_extract_path }}/node_exporter"
    dest: "{{ node_exporter_binary_path }}"
    remote_src: yes
    mode: '0755'
    owner: root
    group: root
  become: true

# Task 4: Add node exporter systemd configuration
- name: "Add node exporter configuration."
  ansible.builtin.copy:
    src: node_exporter.service # Assuming this file is in the role's files/ or templates/ dir
    dest: "{{ node_exporter_service_path }}"
  become: true

# Task 5: Enable and start the node_exporter service
- name: "Enable and start node_exporter service"
  ansible.builtin.systemd:
    state: restarted
    daemon_reload: yes
    name: node_exporter
    enabled: yes
  become: true